// temp_functions.h
#ifndef TEMP_FUNCTIONS_H
#define TEMP_FUNCTIONS_H
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <limits.h>
#include <ctype.h>

#define MAX_RECORDS 650000 //ограничение максимального количества записей 

//=======================================================
//  === Объявление структур для хранения данных ===     |
//=======================================================
// Структура: показание с датчика (с признаком корректной или испорченной записи)
// Примечание: is_valid = 0 → запись корректна, = 1 → запись испорчена
typedef struct __attribute__((packed))
{
    uint16_t year;    // 2 байта, год (0–65535)
    uint8_t month;    // 1 байт (1–12)
    uint8_t day;      // 1 байт (1–31)
    uint8_t hour;     // 1 байт (0–23)
    uint8_t minute;   // 1 байт (0–59)
    int8_t t;         // 1 байт (−99…+99), диапазон укладывается в int8_t
    uint8_t is_valid; // 0 = запись корректна, 1 = испорчена
} sensor;

// Структура: хранения показаний с датчика
typedef struct
{
    uint32_t number;          // общее количество прочитанных записей
    uint32_t invalid_count;   // ★ НОВОЕ: количество испорченных записей во всём файле (is_valid == 1)
    sensor *info;             // динамический массив показаний датчика
} sensor_data;

// Структура для хранения помесячной статистики за год
typedef struct
{
    uint8_t month;     // 1..12
    double avg_temp;   // средняя температура
    int8_t min_temp;   // минимальная
    int8_t max_temp;   // максимальная
    uint32_t count;    // количество корректных записей в этом месяце
} monthly_stats;

// Структура для годовой статистики
typedef struct
{
    uint16_t year;
    double avg_temp;
    int8_t min_temp;
    int8_t max_temp;
    uint32_t count;    // количество корректных записей за год
} yearly_stats;

//=======================================================
//  === Функции работы с файлами ===                    |
//=======================================================
// Функция безопасного открытия файла
// Возвращает FILE* или NULL в случае ошибки (выводит ошибку в stderr)
FILE *safe_fopen(const char *path, const char *mode);

// Функция чтения данных из файла
// Заполняет структуру sensor_
//   - data->number = общее количество прочитанных строк
//   - data->invalid_count = количество строк, помеченных как is_valid == 1
// Возвращает:
//   0 — успех
//  -1..-4 — ошибка (см. реализацию)
int load_data_from_file(sensor_data *d, const char *filename);

//=======================================================
// === Функции  статистики ===                          |
//=======================================================
// Функция вывода статистики за месяц года
// Возвращает:
//   0 — успешно
//  -1 — ошибка (NULL-указатель или пустые данные)
//  -2 — нет корректных записей за указанный месяц
int print_monthly_stats(const sensor_data *data, uint16_t year, uint8_t month);

// Функция вывода статистики за год
// Аналогично возвращает 0 / -1 / -2
int print_yearly_stats(const sensor_data *data, uint16_t year);

//=======================================================
// === Дополнительные функции ===                       |
//=======================================================
// === Функция печати "хелпа" ===
// Выводит справку по использованию программы на stdout
void print_help();

#endif // TEMP_FUNCTIONS_H